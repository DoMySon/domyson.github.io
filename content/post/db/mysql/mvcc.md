---
title: mvcc
date: 2022-11-20
categories: ['mysql']
description: 
toc: true
draft: false
---


# MVCC 

> multi-version concurent control 多版本控制系统，一般用于数据库的并发访问

MVCC在MySQL InnoDB中的实现主要是为了提高数据库的并发性能，用更好的方式去处理读-写冲突，做到即使有读写冲突时，也能做到不加锁，非阻塞并发读。

> mysql 的 RR级别是通过MVCC多版本并发控制的实现的，它通过管理数据行的多个版本来实现数据库并发控制，通过比较版本号来决定数据是否显示

mvcc在很多情况下避免加锁，大多数都实现了非阻塞读操作，写操作也是锁定必要行，innodb在每行记录后面保存两个隐藏列，分别是`创建版本号`和`删除版本号`,每开始一个新的事务系统版本号都会递增，事务开始的时刻的系统版本号
会作为事务的版本号，用以和查询到的每行记录的版本号进行比较，在RR级别下的工作方式：

+ select 需要同时满足查版本号早于当前版本的数据行，行的删除版本要么未定义，要么大于当前数据版本号

+ insert 为插入的每一行记录保存当前系统版本作为创建版本号

+ delete

+ update


# 当前读

像 `select lock in share mode,select for update ,update,insert,delete` 都算当前读，即读取的记录都是数据库中最新的版本，读取是还要保证其他并发事务不能修改当前记录，所以会对读数据加锁


# 快照读

不加锁的`select`就是快照读，但前提是隔离基本不是串行级别，否则会退化成当前读


# 原理

通过隐藏列
