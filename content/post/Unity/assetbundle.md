---
title: assetbundle
date: 2020-09-10
tags: [""]
categories: ["unity"]
description: 
toc: true
draft: false
---


# Assetbundle

> 一种包外资源的存储方案，方便更新以及加载

# Manifest

> 每一个文件夹下都会有一个 Manifest文件，其作用是包含了其下资源的引用关系


# AB管理

+ 资源分类

一般而言我们会根据语言版本进行分类，（如一些有图片文字的资源），然后根据资源的通用性区分是否是共享资源，以减少AB资源冗余，二是根据模块业务来细分。

+ 资源加载

首先应当加载`Manifest`文件读取相关依赖，常用的做法是加载到内存由用户自己控制，因为原始的结构是树状结构，当层次比较深的时候会造成搜索时间过长，转为字典的方式确保索引时间为O(1)

依赖相关的问题，如A依赖于C，A被第一次被加载时，是需要先检查是否C是否被加载。


+ 资源卸载

资源卸载一般都为引用计数的方式，但某些情况下可能会出现刚卸载完就需要被再次使用的场景，这个时候做一个对象池维护一定量的内存资源是合理的方式

其次是资源依赖，如A引用了C，B引用了C，若此时A，B被卸载的时候，C的引用数为0，那么这个时候是否应该卸载C呢？，答案是否定的，也许会存在 D，E,F 同样依赖于C，这个时候最好的做法是将这个资源放入池中，开启循环技术，当到达某个阈值时再释放.

```csharp
public class ABAsset{
    public int Ref;

    public int tick;
}

public class ABManagment{
    // per frame or interval call.
    public void GC(){
        for (){
            ...
            if (ab.Ref == 0){
                ab.tick --;
                if(ab.tick <= 0){
                    // release.
                }
            }
        }

    }
}
```

- 存在的问题

    上述方案从程序的角度上看来是没有逻辑问题的，但如果程序员忘记释放了如何解决这个问题，笔者这里分为两种，
    + 一种非`Monobehaviour`的类，可以通过析构函数。

    + 构建一个公共抽象，由父类实现。


# 资源分包

常常见到的问题是一般资源分多大合适，官方给出的建议是`3~5MB`,但现实情况是分不了这么细怎么办，比如登陆场景的立绘。为了达到效果肯定是不会过大的压缩。这就引申出另外一个问题，过大的资源如何保证不卡顿。一般而言像这种大资源分两种情况

+ 长期使用
    笔者项目一般会做资源预热，像这类资源我们会在首次登陆切换场景的时候就直接加载，保证不会被回收。

+ 仅使用一次
    也会先预热，但之后就会立即卸载，以保证不会占用过多的内存资源


# [引用](https://zhuanlan.zhihu.com/p/593117796)
1. 运行时，AssetBundle驻留控制在40MB以内、数量在1000个以内；
2. 使用LZ4压缩+LoadFromFile加载；
3. 结合项目情况根据依赖树制定打包策略，如公共资源单独打AssetBundle、按使用场景和功能类型分包、独立资源打到一起、Shader/字体等（较为细碎、内存不高、高频使用、最好常驻的）资源打包到一起，启动游戏的时候常驻内存；
4. 结合热更新需求打包；
5. 依赖打包，追求0冗余；
6. 粒度具体没有定值，近期经验上来看会需要尤其警惕AssetBundle包体超过10MB的。