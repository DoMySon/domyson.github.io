<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://domyson.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://domyson.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/light.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/syntax.css' />
    <title>Posts - 朝花夕拾</title>
    
    <link rel="icon" type="image/x-icon" href='/images/avatar.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    

    
    <meta name="description"
  content="" />
<meta name="keywords"
  content='computer tech' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://domyson.github.io/post/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Posts - 朝花夕拾" />
<meta name="twitter:description"
  content="" />
<meta name="twitter:site" content="https://domyson.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://domyson.github.io/">


<meta property="og:type" content="website" />
<meta property="og:title" content="Posts - 朝花夕拾">
<meta property="og:description"
  content="" />
<meta property="og:url" content="https://domyson.github.io/post/" />
<meta property="og:site_name" content="Posts" />
<meta property="og:image"
  content="https://domyson.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">




<link href="/post/index.xml" rel="alternate" type="application/rss+xml" title="朝花夕拾" />








</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://domyson.github.io/">
        <img class="octicon" height="32" width="32" src="/images/avatar.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" id="search-form" action="" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://domyson.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/avatar.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  


<div class="mt-4 position-sticky top-0 d-none d-md-block bg-white width-full border-bottom color-border-secondary"
  style="z-index:3;">
  <div class="container-xl px-3 px-md-4 px-lg-5">
    <div class="gutter-condensed gutter-lg flex-column flex-md-row d-flex">
      <div class="flex-shrink-0 col-12 col-md-3 mb-4 mb-md-0">
      </div>
      <div class="flex-shrink-0 col-12 col-md-9 mb-4 mb-md-0">
        <div class="UnderlineNav width-full box-shadow-none hx_UnderlineNav-with-profile-color-modes-banner">
          <nav class="UnderlineNav-body">
            <a class="UnderlineNav-item " href="https://domyson.github.io/">
              <svg class="octicon octicon-book UnderlineNav-octicon hide-sm" height="16" viewBox="0 0 16 16"
                version="1.1" width="16">
                <path fill-rule="evenodd"
                  d="M0 1.75A.75.75 0 01.75 1h4.253c1.227 0 2.317.59 3 1.501A3.744 3.744 0 0111.006 1h4.245a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75h-4.507a2.25 2.25 0 00-1.591.659l-.622.621a.75.75 0 01-1.06 0l-.622-.621A2.25 2.25 0 005.258 13H.75a.75.75 0 01-.75-.75V1.75zm8.755 3a2.25 2.25 0 012.25-2.25H14.5v9h-3.757c-.71 0-1.4.201-1.992.572l.004-7.322zm-1.504 7.324l.004-5.073-.002-2.253A2.25 2.25 0 005.003 2.5H1.5v9h3.757a3.75 3.75 0 011.994.574z">
                </path>
              </svg>
              Overview
            </a>
            <a class="UnderlineNav-item  selected " href="https://domyson.github.io/post">
              <svg class="octicon octicon-repo UnderlineNav-octicon hide-sm" height="16" viewBox="0 0 16 16"
                version="1.1" width="16">
                <path fill-rule="evenodd"
                  d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z">
                </path>
              </svg>
              Posts
              <span class="Counter">34</span>
            </a>
          </nav>
          <div class="profile-color-modes js-promo-color-modes-banner-profile isInitialToggle">
            <svg width="106" height="60" viewBox="0 0 106 60" fill="none" stroke-width="3" stroke-linecap="round"
              stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
              <g class="profile-color-modes-illu-group profile-color-modes-illu-red">
                <path d="M37.5 58.5V57.5C37.5 49.768 43.768 43.5 51.5 43.5V43.5C59.232 43.5 65.5 49.768 65.5 57.5V58.5">
                </path>
              </g>
              <g class="profile-color-modes-illu-group profile-color-modes-illu-orange">
                <path
                  d="M104.07 58.5C103.401 55.092 97.7635 54.3869 95.5375 57.489C97.4039 54.6411 99.7685 48.8845 94.6889 46.6592C89.4817 44.378 86.1428 50.1604 85.3786 54.1158C85.9519 50.4768 83.7226 43.294 78.219 44.6737C72.7154 46.0534 72.7793 51.3754 74.4992 55.489C74.169 54.7601 72.4917 53.3567 70.5 52.8196">
                </path>
              </g>
              <g class="profile-color-modes-illu-group profile-color-modes-illu-purple">
                <path
                  d="M5.51109 58.5V52.5C5.51109 41.4543 14.4654 32.5 25.5111 32.5C31.4845 32.5 36.8464 35.1188 40.5111 39.2709C40.7212 39.5089 40.9258 39.7521 41.1245 40">
                </path>
                <path d="M27.511 49.5C29.6777 49.5 28.911 49.5 32.511 49.5"></path>
                <path d="M27.511 56.5C29.6776 56.5 26.911 56.5 30.511 56.5"></path>
              </g>
              <g class="profile-color-modes-illu-group profile-color-modes-illu-green">
                <circle cx="5.5" cy="12.5" r="4"></circle>
                <circle cx="18.5" cy="5.5" r="4"></circle>
                <path d="M18.5 9.5L18.5 27.5"></path>
                <path d="M18.5 23.5C6 23.5 5.5 23.6064 5.5 16.5"></path>
              </g>
              <g class="profile-color-modes-illu-group profile-color-modes-illu-blue">
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M40.6983 31.5C40.5387 29.6246 40.6456 28.0199 41.1762 27.2317C42.9939 24.5312 49.7417 26.6027 52.5428 30.2409C54.2551 29.8552 56.0796 29.6619 57.9731 29.6619C59.8169 29.6619 61.5953 29.8452 63.2682 30.211C66.0833 26.5913 72.799 24.5386 74.6117 27.2317C75.6839 28.8246 75.0259 33.7525 73.9345 37.5094C74.2013 37.9848 74.4422 38.4817 74.6555 39">
                  </path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M41.508 31.5C41.6336 31.2259 41.7672 30.9582 41.9085 30.6968C40.7845 26.9182 40.086 21.8512 41.1762 20.2317C42.9939 17.5312 49.7417 19.6027 52.5428 23.2409C54.2551 22.8552 56.0796 22.6619 57.9731 22.6619C59.8169 22.6619 61.5953 22.8452 63.2682 23.211C66.0833 19.5913 72.799 17.5386 74.6117 20.2317C75.6839 21.8246 75.0259 26.7525 73.9345 30.5094C75.1352 32.6488 75.811 35.2229 75.811 38.2283C75.811 38.49 75.8058 38.7472 75.7957 39">
                  </path>
                  <path d="M49.4996 33V35.6757"></path>
                  <path d="M67.3375 33V35.6757"></path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M41.508 31.5C41.6336 31.2259 41.7672 30.9582 41.9085 30.6968C40.7845 26.9182 40.086 21.8512 41.1762 20.2317C42.9939 17.5312 49.7417 19.6027 52.5428 23.2409C54.2551 22.8552 56.0796 22.6619 57.9731 22.6619C59.8169 22.6619 61.5953 22.8452 63.2682 23.211C66.0833 19.5913 72.799 17.5386 74.6117 20.2317C75.6839 21.8246 75.0259 26.7525 73.9345 30.5094C75.1352 32.6488 75.811 35.2229 75.811 38.2283C75.811 38.49 75.8058 38.7472 75.7957 39">
                  </path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M41.508 31.5C41.6336 31.2259 41.7672 30.9582 41.9085 30.6968C40.7845 26.9182 40.086 21.8512 41.1762 20.2317C42.9939 17.5312 49.7417 19.6027 52.5428 23.2409C54.2551 22.8552 56.0796 22.6619 57.9731 22.6619C59.8169 22.6619 61.5953 22.8452 63.2682 23.211C66.0833 19.5913 72.799 17.5386 74.6117 20.2317C75.6839 21.8246 75.0259 26.7525 73.9345 30.5094C75.1352 32.6488 75.811 35.2229 75.811 38.2283C75.811 38.49 75.8058 38.7472 75.7957 39">
                  </path>
                  <path d="M49.4996 33V35.6757"></path>
                  <path d="M67.3375 33V35.6757"></path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M41.508 31.5C41.6336 31.2259 41.7672 30.9582 41.9085 30.6968C40.7845 26.9182 40.086 21.8512 41.1762 20.2317C42.9939 17.5312 49.7417 19.6027 52.5428 23.2409C54.2551 22.8552 56.0796 22.6619 57.9731 22.6619C59.8169 22.6619 61.5953 22.8452 63.2682 23.211C66.0833 19.5913 72.799 17.5386 74.6117 20.2317C75.6839 21.8246 75.0259 26.7525 73.9345 30.5094C75.1352 32.6488 75.811 35.2229 75.811 38.2283C75.811 38.49 75.8058 38.7472 75.7957 39">
                  </path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M41.508 31.5C41.6336 31.2259 41.7672 30.9582 41.9085 30.6968C40.7845 26.9182 40.086 21.8512 41.1762 20.2317C42.9939 17.5312 49.7417 19.6027 52.5428 23.2409C54.2551 22.8552 56.0796 22.6619 57.9731 22.6619C59.8169 22.6619 61.5953 22.8452 63.2682 23.211C66.0833 19.5913 72.799 17.5386 74.6117 20.2317C75.6839 21.8246 75.0259 26.7525 73.9345 30.5094C75.1352 32.6488 75.811 35.2229 75.811 38.2283C75.811 38.49 75.8058 38.7472 75.7957 39">
                  </path>
                  <path d="M49.4996 33V35.6757"></path>
                  <path d="M67.3375 33V35.6757"></path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M73.4999 40.2236C74.9709 38.2049 75.8108 35.5791 75.8108 32.2283C75.8108 29.2229 75.1351 26.6488 73.9344 24.5094C75.0258 20.7525 75.6838 15.8246 74.6116 14.2317C72.7989 11.5386 66.0832 13.5913 63.2681 17.211C61.5952 16.8452 59.8167 16.6619 57.973 16.6619C56.0795 16.6619 54.2549 16.8552 52.5427 17.2409C49.7416 13.6027 42.9938 11.5312 41.176 14.2317C40.0859 15.8512 40.7843 20.9182 41.9084 24.6968C41.003 26.3716 40.4146 28.3065 40.2129 30.5">
                  </path>
                  <path d="M82.9458 30.5471L76.8413 31.657"></path>
                  <path d="M76.2867 34.4319L81.8362 37.7616"></path>
                  <path d="M49.4995 27.8242V30.4999"></path>
                  <path d="M67.3374 27.8242V30.4998"></path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M45.3697 34.2658C41.8877 32.1376 39.7113 28.6222 39.7113 23.2283C39.7113 20.3101 40.3483 17.7986 41.4845 15.6968C40.3605 11.9182 39.662 6.85125 40.7522 5.23168C42.5699 2.53117 49.3177 4.6027 52.1188 8.24095C53.831 7.85521 55.6556 7.66186 57.5491 7.66186C59.3929 7.66186 61.1713 7.84519 62.8442 8.21095C65.6593 4.59134 72.375 2.5386 74.1877 5.23168C75.2599 6.82461 74.6019 11.7525 73.5105 15.5094C74.7112 17.6488 75.3869 20.2229 75.3869 23.2283C75.3869 28.6222 73.2105 32.1376 69.7285 34.2658C70.8603 35.5363 72.6057 38.3556 73.3076 40">
                  </path>
                  <path d="M49.0747 19.8242V22.4999"></path>
                  <path
                    d="M54.0991 28C54.6651 29.0893 55.7863 30.0812 57.9929 30.0812C59.0642 30.0812 59.8797 29.8461 60.5 29.4788">
                  </path>
                  <path d="M66.9126 19.8242V22.4999"></path>
                  <path d="M33.2533 20.0237L39.0723 22.1767"></path>
                  <path d="M39.1369 25.0058L33.0935 27.3212"></path>
                  <path d="M81.8442 19.022L76.0252 21.1751"></path>
                  <path d="M75.961 24.0041L82.0045 26.3196"></path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M73.4999 40.2236C74.9709 38.2049 75.8108 35.5791 75.8108 32.2283C75.8108 29.2229 75.1351 26.6488 73.9344 24.5094C75.0258 20.7525 75.6838 15.8246 74.6116 14.2317C72.7989 11.5386 66.0832 13.5913 63.2681 17.211C61.5952 16.8452 59.8167 16.6619 57.973 16.6619C56.0795 16.6619 54.2549 16.8552 52.5427 17.2409C49.7416 13.6027 42.9938 11.5312 41.176 14.2317C40.0859 15.8512 40.7843 20.9182 41.9084 24.6968C41.003 26.3716 40.4146 28.3065 40.2129 30.5">
                  </path>
                  <path d="M82.9458 30.5471L76.8413 31.657"></path>
                  <path d="M76.2867 34.4319L81.8362 37.7616"></path>
                  <path d="M49.4995 27.8242V30.4999"></path>
                  <path d="M67.3374 27.8242V30.4998"></path>
                </g>
                <g class="profile-color-modes-illu-frame">
                  <path
                    d="M40.6983 31.5C40.5387 29.6246 40.6456 28.0199 41.1762 27.2317C42.9939 24.5312 49.7417 26.6027 52.5428 30.2409C54.2551 29.8552 56.0796 29.6619 57.9731 29.6619C59.8169 29.6619 61.5953 29.8452 63.2682 30.211C66.0833 26.5913 72.799 24.5386 74.6117 27.2317C75.6839 28.8246 75.0259 33.7525 73.9345 37.5094C74.2013 37.9848 74.4422 38.4817 74.6555 39">
                  </path>
                </g>
              </g>
            </svg>
            <span class="profile-color-modes-toggle js-promo-color-modes-toggle no-select" tabindex="0"
              onclick="switchTheme()">
              <div class="profile-color-modes-toggle-track no-select"></div>
              <div class="profile-color-modes-toggle-thumb js-promo-color-modes-thumb">
                <svg style="fill: var(--color-profile-color-modes-toggle-moon); margin: 7px 0 0 7px;" width="14"
                  height="13" viewBox="0 0 14 13" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
                  </path>
                </svg>
              </div>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-xl px-3 px-md-4 px-lg-5">
  <div class="gutter-condensed gutter-lg flex-column flex-md-row d-flex">
    <div class="flex-shrink-0 col-12 col-md-3 mb-4 mb-md-0">
      <div class="h-card mt-md-n5" style="margin-top:24px">
        <div class="user-profile-sticky-bar js-user-profile-sticky-bar d-none d-md-block" id="headerStuck">
          <div class="user-profile-mini-vcard d-table">
            <span class="user-profile-mini-avatar d-table-cell v-align-middle lh-condensed-ultra pr-2">
              
              <img class="rounded-1 avatar-user" height="32" width="32" src="/images/avatar.png">
              
            </span>
            <span class="d-table-cell v-align-middle lh-condensed">
              <strong>Treasure</strong>
            </span>
          </div>
        </div>
        <div class="clearfix d-flex d-md-block flex-items-center mb-4 mb-md-0">
          <div class="position-relative d-inline-block col-2 col-md-12 mr-3 mr-md-0 flex-shrink-0" style="z-index:4;">
            
            <a href="/images/avatar.png">
              <img style="height:auto;" alt="Avatar" width="260" height="260" id="headerImg"
                class="avatar avatar-user width-full border bg-white" src="/images/avatar.png">
            </a>
            
            
            <div class="user-status-container position-relative hide-sm hide-md">
              <div class="f5 user-status-circle-badge-container">
                <div class="user-status-circle-badge d-inline-block lh-condensed-ultra p-2">
                  <div class="d-flex flex-items-center flex-items-stretch">
                    <div class="f6 lh-condensed user-status-header d-inline-flex user-status-emoji-only-header circle">
                      <div class="user-status-emoji-container flex-shrink-0 mr-2 d-flex flex-items-center flex-justify-center ">
                        <div><g-emoji class="g-emoji">😀</g-emoji></div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
          </div>

          <div
            class="vcard-names-container float-left col-10 col-md-12 pt-1 pt-md-3 pb-1 pb-md-3 js-sticky js-user-profile-sticky-fields"
            data-original-top="0px" style="position: sticky;">
            <h1 class="vcard-names pl-2 pl-md-0">
              <span class="p-name vcard-fullname d-block overflow-hidden">Treasure</span>
              
              <span class="p-nickname vcard-username d-block">domyson</span>
              
            </h1>
          </div>
        </div>

        <div class="p-note user-profile-bio mb-3 js-user-profile-bio f4">
          <div>无关迟暮，不问翻覆.</div>
        </div>

        <div class="d-flex flex-column">
          <div class="js-profile-editable-area d-flex flex-column d-md-block">
            <ul class="vcard-details">
              
              <li class="vcard-detail pt-1 css-truncate css-truncate-target hide-sm hide-md">
                <svg class="octicon octicon-location" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                  <path fill-rule="evenodd"
                    d="M11.536 3.464a5 5 0 010 7.072L8 14.07l-3.536-3.535a5 5 0 117.072-7.072v.001zm1.06 8.132a6.5 6.5 0 10-9.192 0l3.535 3.536a1.5 1.5 0 002.122 0l3.535-3.536zM8 9a2 2 0 100-4 2 2 0 000 4z">
                  </path>
                </svg>
                <span class="p-label">China</span>
              </li>
              

              
              <li class="vcard-detail pt-1 css-truncate css-truncate-target ">
                <svg class="octicon octicon-mail" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                  <path fill-rule="evenodd"
                    d="M1.75 2A1.75 1.75 0 000 3.75v.736a.75.75 0 000 .027v7.737C0 13.216.784 14 1.75 14h12.5A1.75 1.75 0 0016 12.25v-8.5A1.75 1.75 0 0014.25 2H1.75zM14.5 4.07v-.32a.25.25 0 00-.25-.25H1.75a.25.25 0 00-.25.25v.32L8 7.88l6.5-3.81zm-13 1.74v6.441c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V5.809L8.38 9.397a.75.75 0 01-.76 0L1.5 5.809z">
                  </path>
                </svg>
                <a class="u-email link-gray-dark " href="mailto:cnmlgbbg@hotmail.com">cnmlgbbg@hotmail.com</a>
              </li>
              

              <li class="vcard-detail pt-1 css-truncate css-truncate-target ">
                <svg class="octicon octicon-link" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                  <path fill-rule="evenodd"
                    d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z">
                  </path>
                </svg>
                
                <a rel="nofollow me" class="link-gray-dark" href="https://domyson.github.io">https://domyson.github.io</a>
                
              </li>
            </ul>
          </div>
        </div>

        <div class="border-top color-border-secondary pt-3 mt-3 clearfix hide-sm hide-md">
          <h2 class="mb-2 h4">Organizations</h2>
          <div style="display:flex;justify-content:flex-start;flex-wrap:wrap;margin-bottom:3px;">
          
          <a style="margin: 0 10px 10px 0;" href="https://github.com/domyson">
            <svg id="github-icon" viewBox="0 0 16 16" version="1.1" width="32" height="32" fill="#24292e">
              <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
              </path>
            </svg>
          </a>
          

          

          

          

          

          

          

          

          
          
          
          <a style="margin: 0 10px 10px 0;" href="https://github.com/domyson">
            <img alt="@Link" width="32" height="32" src='https://domyson.github.io/images/link.png' class="avatar">
          </a>
          
          
          

          
          <a style="margin: 0 10px 10px 0;" href="https://domyson.github.io/index.xml">
            <img alt="@rss" width="32" height="32" src="https://domyson.github.io/images/rss.png" class="avatar">
          </a>
          
         </div>
        </div>
      </div>
    </div>

    <div class="flex-shrink-0 col-12 col-md-9 mb-4 mb-md-0">
      

<div class="UnderlineNav user-profile-nav d-block d-md-none position-sticky top-0 pl-3 ml-n3 mr-n3 pr-3 bg-white"
  style="z-index:3;">
  <nav class="UnderlineNav-body">
    <a class="UnderlineNav-item " href="https://domyson.github.io/">
      <svg class="octicon octicon-book UnderlineNav-octicon hide-sm" height="16" viewBox="0 0 16 16" version="1.1"
        width="16">
        <path fill-rule="evenodd"
          d="M0 1.75A.75.75 0 01.75 1h4.253c1.227 0 2.317.59 3 1.501A3.744 3.744 0 0111.006 1h4.245a.75.75 0 01.75.75v10.5a.75.75 0 01-.75.75h-4.507a2.25 2.25 0 00-1.591.659l-.622.621a.75.75 0 01-1.06 0l-.622-.621A2.25 2.25 0 005.258 13H.75a.75.75 0 01-.75-.75V1.75zm8.755 3a2.25 2.25 0 012.25-2.25H14.5v9h-3.757c-.71 0-1.4.201-1.992.572l.004-7.322zm-1.504 7.324l.004-5.073-.002-2.253A2.25 2.25 0 005.003 2.5H1.5v9h3.757a3.75 3.75 0 011.994.574z">
        </path>
      </svg>
      Overview
    </a>
    <a class='UnderlineNav-item   selected '
      href="https://domyson.github.io/post">
      <svg class="octicon octicon-repo UnderlineNav-octicon hide-sm" height="16" viewBox="0 0 16 16" version="1.1"
        width="16">
        <path fill-rule="evenodd"
          d="M2 2.5A2.5 2.5 0 014.5 0h8.75a.75.75 0 01.75.75v12.5a.75.75 0 01-.75.75h-2.5a.75.75 0 110-1.5h1.75v-2h-8a1 1 0 00-.714 1.7.75.75 0 01-1.072 1.05A2.495 2.495 0 012 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 011-1h8zM5 12.25v3.25a.25.25 0 00.4.2l1.45-1.087a.25.25 0 01.3 0L8.6 15.7a.25.25 0 00.4-.2v-3.25a.25.25 0 00-.25-.25h-3.5a.25.25 0 00-.25.25z">
        </path>
      </svg>
      Posts
      <span class="Counter ">34</span>
    </a>
  </nav>
</div>

      
      
<div>
  <div class="position-relative">
    <div>
      
        
          <style>
	.tags { padding: 15px 0; }
</style>
<div class="f6 text-gray mt-2 tags border-bottom">
	
	
	<a class="muted-link mr-3" href="/categories/cloud-native/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		cloud native
	</a>
	
	<a class="muted-link mr-3" href="/categories/go/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		go
	</a>
	
	<a class="muted-link mr-3" href="/categories/linux/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		linux
	</a>
	
	<a class="muted-link mr-3" href="/categories/mysql/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		mysql
	</a>
	
	<a class="muted-link mr-3" href="/categories/net/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		net
	</a>
	
	<a class="muted-link mr-3" href="/categories/others/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		others
	</a>
	
	<a class="muted-link mr-3" href="/categories/skynet-x/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		skynet-x
	</a>
	
	<a class="muted-link mr-3" href="/categories/typelang/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		typelang
	</a>
	
	<a class="muted-link mr-3" href="/categories/zen/">
		
		<svg class="octicon octicon-package" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M8.878.392a1.75 1.75 0 00-1.756 0l-5.25 3.045A1.75 1.75 0 001 4.951v6.098c0 .624.332 1.2.872 1.514l5.25 3.045a1.75 1.75 0 001.756 0l5.25-3.045c.54-.313.872-.89.872-1.514V4.951c0-.624-.332-1.2-.872-1.514L8.878.392zM7.875 1.69a.25.25 0 01.25 0l4.63 2.685L8 7.133 3.245 4.375l4.63-2.685zM2.5 5.677v5.372c0 .09.047.171.125.216l4.625 2.683V8.432L2.5 5.677zm6.25 8.271l4.625-2.683a.25.25 0 00.125-.216V5.677L8.75 8.432v5.516z">
			</path>
		</svg>
		
		zen
	</a>
	
	
	
	<a class="muted-link mr-3" href="/tags/docker/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		docker
	</a>
	
	<a class="muted-link mr-3" href="/tags/gc/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		gc
	</a>
	
	<a class="muted-link mr-3" href="/tags/goroutine/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		goroutine
	</a>
	
	<a class="muted-link mr-3" href="/tags/i/o/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		i/o
	</a>
	
	<a class="muted-link mr-3" href="/tags/markdown/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		markdown
	</a>
	
	<a class="muted-link mr-3" href="/tags/sync.pool/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		sync.pool
	</a>
	
	<a class="muted-link mr-3" href="/tags/tcp/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		tcp
	</a>
	
	<a class="muted-link mr-3" href="/tags/tls/">
		
		<svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
			<path fill-rule="evenodd"
				d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
			</path>
		</svg>
		
		tls
	</a>
	
	
</div>
        
      
      <ul>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/zen/0/">Zen Gameplay Framework</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="序">序</h1>
<p><code>Zen</code> 是一个基于 Unity 引擎的<code>GamePlay</code>框架，脱离 <code>Monobehaviour</code> 开发，致力简化开发流程。内部提供了一个类<code>ECS</code>的架构满足开发，你也可以使用自定义的上层，比如自己实现像<code>MVCC</code>，或者是<code>MVC</code>的上层封装。让开发聚焦在游戏玩法而非一些底层架构上。</p>
<blockquote>
<p>Zen的一些设计思想不算是纯粹的<code>OOP</code>，它有ECS的概念，也有<code>type embedding</code>的概念，而且设计概念大部分是参考面过过程和内嵌的设计思想，所以理解曲线会比较困难</p>
</blockquote>
<h1 id="设计目标">设计目标</h1>
<ol>
<li>
<p>无框架化，它之所有不提供是为了更好的设计出不同品类的游戏，而我在近10年的游戏开发生涯中，我始终觉得框架的约束即使最大的约束，因为业务的多样性和非明确性的特点，一般游戏后期的一些奇奇怪怪的需求总是会迫使你绕过框架的约束从而形成屎山code，所以我希望<code>Zen</code>框架本身可以尽可能的简单，让开发者可以自由的去选择框架的约束。你可使用<code>Zen</code>的一部分，或者全部，甚至是都不需要。</p>
</li>
<li>
<p>无<code>MonoBehaviour</code>编程设计，解除引擎原始的约束，更自由的编程方式，像之前开发游戏，一个角色身上可能挂在各式各样的组件，一旦后期业务变动很容易出现引用丢失或者维护起来更为困难，而且一些特殊的时候可能还需要设置一下脚本的执行顺序，给维护带来巨大的不便（如我之前所呆的项目各种口口相传的细节规范，让开发痛不欲生）</p>
</li>
<li>
<p>模块化，<code>Zen</code>的一大特色，以像<code>C library</code>的方式来组织模块，让模块之间可以互相调用，并且可以互相替换，让开发者可以自由的去选择模块的约束。选择何种内置模块，或者是自定义模块由开发者决定，这也是使用 <code>Zen</code> 唯一的约束，你的模块可以是框架，也可以是<code>Module</code>。</p>
</li>
<li>
<p>简单化，<code>Zen</code> 本身只提最必要的一些基础组件，你可以重新实现，而并非是必要的</p>
</li>
<li>
<p>自由化，游戏开发是自由的，是创造性的，<code>Zen</code> 不会约束你干什么，你只需要关注你的想法，怎么做取决于你的点子。</p>
</li>
<li>
<p>非文档约束性组件控制器绑定，面向对象的模式必然导致代码变得复杂，因使用内嵌代替<code>OOP</code>，但显然C#做不到，需要额外的封装，但过于麻烦不符合<code>Zen</code>的设计哲学，故通过静态泛型约束实现。</p>
</li>
<li>
<p>无任何反射调度，提高代码的运行速度。</p>
</li>
<li>
<p>高度继承的构建管线，非常完善且易使用基建设计（配置，资源，本地化，网络等）</p>
</li>
<li>
<p><code>ZenRpc</code>现在可用了，无关乎网络，无缝与 <a href="https://domyson.github.io/">skynet-go</a></p>
</li>
</ol>
<blockquote>
<p><code>Zen</code>不鼓励继承，其内部设计也是符合此规范，所以整个拓扑架构更平整</p>
</blockquote>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              
              
              <a class="muted-link mr-3" href="/tags/">
                <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                  <path fill-rule="evenodd"
                    d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                  </path>
                </svg>
                
              </a>
              
              

              Created
              <relative-time datetime=" Sat, 01 Apr 2023 00:00:00 &#43;0000" class="no-wrap"
                title=" Sat, 01 Apr 2023 00:00:00 &#43;0000">
                Sat, 01 Apr 2023 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/redis/">redis</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="redis">Redis</h1>
<blockquote>
<p>Remote Dictionary Server,采用 ANSI C 编写的 K-V数据库</p>
</blockquote>
<blockquote>
<p><a href="http://doc.redisfans.com/index.html">Redis命令</a></p>
</blockquote>
<blockquote>
<p><a href="https://redis.io/download">Redis下载</a></p>
</blockquote>
<h1 id="类型">类型</h1>
<ul>
<li>
<p>string
最大存储值为256mb，底层由SDS(simple dynamic string)实现，优势是访问长度仅需O(1)</p>
</li>
<li>
<p>hash</p>
</li>
<li>
<p>list
存储有序字符串，最大2^32-1个元素</p>
</li>
<li>
<p>set</p>
</li>
</ul>
<p>同list，但不允许重复</p>
<ul>
<li>sorted set
已排序的都字符串集合，但不允许重复</li>
</ul>
<p>&ndash; 其它</p>
<ol>
<li>GEO 地理位置</li>
<li>HyperLogLog 基数统计</li>
<li>Bitsmap bit数组，类似boolean filter</li>
</ol>
<h1 id="redis设计架构">redis设计架构</h1>
<ol>
<li>
<p>单线程业务，多线程存储，redis6.0引入多线程也仅仅是为了提高解析命令的速度</p>
</li>
<li>
<p>虚拟内存</p>
</li>
</ol>
<blockquote>
<p>虚拟内存机制就是暂时把不经常访问的数据(冷数据)从内存交换到磁盘中，从而腾出宝贵的内存空间用于其它需要访问的数据(热数据)。通过VM功能可以实现冷热数据分离，使热数据仍在内存中、冷数据保存到磁盘。这样就可以避免因为内存不足而造成访问速度下降的问题。</p>
</blockquote>
<h1 id="击穿穿透雪崩">击穿，穿透，雪崩</h1>
<h2 id="击穿">击穿</h2>
<p>某个key在过期点的时候，突然出现大量请求查找这个key</p>
<h2 id="穿透">穿透</h2>
<p>访问一个不存在的key的时候</p>
<h2 id="雪崩">雪崩</h2>
<p>指缓存中数据大批量到过期时间，访问落到db上，造成db压力过大</p>
<h1 id="持久化机制">持久化机制</h1>
<h2 id="rdb">RDB</h2>
<p>RDB持久化，是指在指定的时间间隔内，执行指定次数的写操作，将内存中的数据集快照写入磁盘中，它是Redis默认的持久化方式。执行完操作后，在指定目录下会生成一个dump.rdb文件，Redis 重启的时候，通过加载dump.rdb文件来恢复数据</p>
<p>分为手动触发和自动触发</p>
<p>优点 适合大规模的数据恢复场景，如备份，全量复制等</p>
<p>缺点 没办法做到实时持久化/秒级持久化。</p>
<h2 id="aof">AOF</h2>
<p>采用日志的形式来记录每个写操作，追加到文件中，重启时再重新执行AOF文件中的命令来恢复数据。它主要解决数据持久化的实时性问题</p>
<p>优点 数据一致性和完整性更高
缺点 内容越多，文件越大，恢复变慢，它需要将所有命令执行一遍</p>
<h1 id="高可用">高可用</h1>
<h2 id="主从">主从</h2>
<blockquote>
<p>类似mysql主从，master负责写，slave负责读</p>
</blockquote>
<h2 id="哨兵">哨兵</h2>
<p>监视其他节点的状态</p>
<h2 id="集群">集群</h2>
<p>Gossip，HashSlot 16384</p>
<p><a href="https://zhuanlan.zhihu.com/p/427496556">View</a></p>
<h1 id="分布式锁">分布式锁</h1>
<h2 id="setnx">setnx</h2>
<blockquote>
<p>setnx nx [expired]</p>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              

              Created
              <relative-time datetime=" Thu, 24 Nov 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Thu, 24 Nov 2022 00:00:00 &#43;0000">
                Thu, 24 Nov 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/linux/iptables/">iptables and ipvs</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="iptables">iptables</h1>
<p><code>iptables</code> 基于 <code>netfilter</code> 采用一条条规则链表，时间复杂度为O(n)，最主要的是 <code>iptables</code> 专为防火墙设计</p>
<h1 id="ipvs">ipvs</h1>
<p><code>ipvs</code> 同样基于 <code>netfilter</code>，但底层采用的是hash表，索引复杂度为O(1)</p>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              
              
              <a class="muted-link mr-3" href="/tags/">
                <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                  <path fill-rule="evenodd"
                    d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                  </path>
                </svg>
                
              </a>
              
              

              Created
              <relative-time datetime=" Sat, 19 Nov 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Sat, 19 Nov 2022 00:00:00 &#43;0000">
                Sat, 19 Nov 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/kproto/">kproto 编码协议</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="前言">前言</h1>
<p>其实在<code>cobweb</code>之初就设计了一种编码协议(kproto)，用于内部消息的编码,但因为公司项目长期需要维护以及开发（两款线上，一款开发中），所以一直未对此库进行维护，
而后期在研发的时候，发现需要与多种语言交互，显然 <code>json</code>,<code>xml</code> 不是一个很好的选择，而 <code>protobuf</code> 对弱类型语言支持不友好。</p>
<h1 id="benchmark">Benchmark</h1>
<ul>
<li>cpu: Intel(R) Core(TM) i9-9900K CPU @ 3.60GHz</li>
<li>os: windows11</li>
<li>arch: amd64</li>
</ul>
<table>
  <thead>
      <tr>
          <th style="text-align: center">format</th>
          <th style="text-align: center">compress rate</th>
          <th style="text-align: center">encode rate</th>
          <th style="text-align: center">decode rate</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">json std</td>
          <td style="text-align: center">0%</td>
          <td style="text-align: center">0%( 213.8 ns/op)</td>
          <td style="text-align: center">0%(1204ns/op)</td>
      </tr>
      <tr>
          <td style="text-align: center">proto v3</td>
          <td style="text-align: center">-40%</td>
          <td style="text-align: center">-51%(98.36 ns/op)</td>
          <td style="text-align: center">-84%(190.1ns/op)</td>
      </tr>
      <tr>
          <td style="text-align: center">kproto</td>
          <td style="text-align: center">-40%</td>
          <td style="text-align: center">-76% (65.21 ns/op)</td>
          <td style="text-align: center">-95%(62.18ns/op)</td>
      </tr>
  </tbody>
</table>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              
              
              <a class="muted-link mr-3" href="/tags/">
                <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                  <path fill-rule="evenodd"
                    d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                  </path>
                </svg>
                
              </a>
              
              

              Created
              <relative-time datetime=" Wed, 21 Sep 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Wed, 21 Sep 2022 00:00:00 &#43;0000">
                Wed, 21 Sep 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/skynet/1/">message</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="简介">简介</h1>
<p><code>skynet-x</code>是基于<code>actor</code> 消息的服务框架，那么我们需要定义一套标准且高效的消息结构</p>
<h2 id="processor">Processor</h2>
<p>一个伪线程的逻辑处理器概念，它分为独占和负载两种模式。</p>
<ul>
<li>
<p>独占<code>Processor</code>是为了更好的处理实时性更高的业务，它不会被其他任务抢占</p>
</li>
<li>
<p>负载<code>Processor</code>又可分为两种运行态，均匀的处理业务以及从其他<code>Processor</code>上偷窃任务，尽量保证<code>Processor</code>不会过于闲置，除此之外，负载<code>Processor</code>可随着任务的变动而增加（不会超过最大设定值），特别的当某个任务陷入”死循环”或者是超出设定运行阈值的时候会重新创建一个<code>Processor</code>，并让之前的挂起（在C版本中将会被强制关闭）。</p>
</li>
</ul>
<blockquote>
<p>C版本和Go版本调度和设计上差异不大，但一些细节上的处理可能不同，因为C可以提供更多的底层控制</p>
</blockquote>
<h2 id="pid">PID</h2>
<p>一个 <code>message</code> 最重要的是消息地址，如果一个消息没有地址的话我们称为 <code>dead-letter</code>。 那么我们通过<code>Pid</code> 标定一个地址类型，</p>
<p>它表示该服务的唯一id (本质上是一个<code>uint64</code>)的类习惯，它一定能确保在当前节点以及集群中唯一的。</p>
<p>在服务本身未被关闭的时候，<code>pid</code>一定不会产生变动，但重新启动节点之后，它的值可能会发生改变，因为所有服务默认都是并发启动，除非手动指定了关系(这也是它与<code>skynet-x</code>的区别)，所以不要尝试保存这个<code>pid</code></p>
<p>一旦能确定了一个<code>pid</code>的话，就可以通过 <code>skynet.send(pid,cmd,...) or skynet.call(ti,pid,cmd,...)</code> 将其发送出去了。</p>
<h2 id="服务的消息队列">服务的消息队列</h2>
<p><code>Actor</code> 模型最重要的的概念是 <code>mailbox</code>,它代表了一个实体需要处理的队列容器，</p>
<p>得益于<code>go</code>的简单性，可以使用 <code>channel</code> 来实现，但这种方式的实现性能不高，因为 <code>channel</code> 底层的结构使用的是互斥锁，</p>
<p>所以我采用了<code>mpsc</code> 实现了无锁队列，性能更优于 <code>channel</code></p>
<p>TODO: 吞吐量对比</p>
<h1 id="消息的接受和发送">消息的接受和发送</h1>
<ul>
<li>发送</li>
</ul>
<p>用户不需要构建这个结构体，仅仅需要指定 <code>destination</code> 以及需要发送的数据，而且 <code>skynet-x</code> 消息投递被设计成不允许发送 <code>nil</code> 因为这是无任何意义的，相反它还会消耗服务投递的性能，如果确实有这种需求，可以发送 <code>struct{}{}</code>。</p>
<p>而且消息发送成功只能代表被 <code>mailbox</code> 接受了，不代表会被立即处理，而不会一定处理成功，所以需要正确理解这种方式。</p>
<p>如果发送失败，那么一定失败，并返回一个错误</p>
<ul>
<li>接收</li>
</ul>
<p>接受回调只包含<code>5</code>个关键参数 <code>context</code>,<code>addr</code>,<code>session</code>,<code>mtype</code>,<code>argument</code></p>
<ul>
<li>
<p><code>context</code> 其实就是创建服务用户指定的结构指针，用于数据传递和状态修改</p>
</li>
<li>
<p><code>session</code> 主要的作用是用以区分这条消息是否是同步请求， 如若大于0，则其值就是请求序列号,只需要通过 <code>skynet.ret(msg)</code> 返回即可</p>
</li>
<li>
<p><code>mtype</code> 仅仅是一个消息类别的区分，类似于消息号，用户可自行定义，可作为<code>rpc</code>消息类型</p>
</li>
<li>
<p><code>argument</code> 才是真实的数据，它可以是任意值，特别的，在<code>lua</code>中这个值是会被解构，在跨节点通讯这个值恒为 <code>[]byte</code>，<del>当不需要时记得 skynet.free</del>  1.4.0 这个由底层回收，用户不用关心</p>
</li>
</ul>
<h1 id="异步消息">异步消息</h1>
<p>异步消息通过 <code>skynet.send</code>的方式进行投递，它只在乎这个消息有没有正确到达到对点服务，而不关心是否能被对点服务正确处理，并返回一个 <code>error</code></p>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              

              Created
              <relative-time datetime=" Fri, 22 Jul 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Fri, 22 Jul 2022 00:00:00 &#43;0000">
                Fri, 22 Jul 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/skynet/0/">skynet-x 服务器框架简介</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <p>工作中曾经开发了一个<code>cobweb</code>的分布式服务器框架（基于<code>golang</code>,<code>c</code>）,但是在实际开发过程中代码难以维护以及更新，主要是每次都需要跨平台进行编译，特别是<code>cgo</code> 往往需要指定平台的系统库,而且一些不规范的使用方式造成无法充分发挥多核的优势，可以参见 <code>关于Go协程的思考</code> 虽然1.16 支持抢占式，但错误的使用方式依然造成了cpu过高的问题。，后续重新设计了<code>skynet-x</code> 是一个<code>actor</code>模型分布式服务框架，使用<code>go</code>编写。</p>
<p>尽管<code>Actor</code>模型和<code>CSP</code>模型各有所有长，为什么不采用<code>CSP</code>主要有两方面考虑。</p>
<ol>
<li><code>CSP</code>模式使用尽管很简单，但是一个致命的问题是无法控制消息的优先级，当然若只处理一个<code>Channel</code>那可以规避，那么为啥还需要使用<code>CSP</code>,而且像go channel 本身是基于互斥锁（1.16）实现，且无法进行优化和更加精细的控制，只能依赖于<code>runtime</code>的调度。（网上所说什么时候触发调度，我认为channel不能包含其中，它本质也是加锁导致切换）</li>
<li>隔离性太弱，后续一些新的<code>channel</code>引入也会造成破坏性修改，而且 <code>select-case</code>模式等待的<code>channel</code>会随着数量的增加性能会慢慢减弱。</li>
</ol>
<p>它是一个年轻的框架，仅仅经历了两款项目的迭代 现在版本为 <code>v1.6.0 2023-05-28</code></p>
<ul>
<li><a href="https://www.taptap.cn/app/229839">羽翼军团</a> v1.3.0</li>
<li><a href="https://www.taptap.cn/app/215934">我在民国淘古玩</a> v.1.3.5</li>
</ul>
<h1 id="与skynet的差异">与skynet的差异</h1>
<ol>
<li>
<p>增加了独占进程的概念，对于一些性能敏感的服务可以绕过公平调度的原则。（公平调度是一个很普遍但并非最优解的调度策略，但对于需要占用资源较多的进程就显得无力）</p>
</li>
<li>
<p>使用协程而非线程，一个好处是对于一些假死服务我们可以重新启动它，其它代价远小于线程（尽管协程的开销很低，但我们尽量保证不会被滥用）</p>
</li>
<li>
<p>一个简单的二进制文件，<code>skynet</code>修改了lua部分虚拟机源码，而且大部分实现都是基于<code>lua</code>实现，而我设计的是一个将脚本语言作为可选项的插件。</p>
</li>
<li>
<p>所有库都是底层语言的实现方式，可控制力和性能更好，完全将业务和底层区分方便同时进行维护</p>
</li>
<li>
<p>无感的集群交互方式，调用其他服务（无论在不在本地）就像普通消息那样简单，不需要像<code>skynet</code>需要显示调用<code>cluster</code>。</p>
</li>
<li>
<p>进程支持错误重启且消息不会丢失（beta)</p>
</li>
<li>
<p>支持后续的<a href="/post/typelang/0">DSL</a></p>
</li>
<li>
<p>在2024/03我正计划重新用C实现了一版以提供更好的性能和更底层的控制</p>
</li>
</ol>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              

              Created
              <relative-time datetime=" Mon, 20 Jun 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Mon, 20 Jun 2022 00:00:00 &#43;0000">
                Mon, 20 Jun 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/skynet/3/">sktpmd</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="简介">简介</h1>
<p><code>sktpmd</code>模块是<code>skynet-x</code>底层集群模块，它承担了<code>skynet-x</code>网络节点之间的通讯职能。全名为(<code>skynet port managment daemon</code>)</p>
<h1 id="架构">架构</h1>
<ol>
<li>
<p><code>sktpmd</code> 为了满足对等网络的性质，所以每次和其他节点建立连接是有两条连接，
当A节点于B节点建立连接，首先A节点发送握手等待B确认，B确认完成之后重复走A的流程，这样一个双向连接就被建立了起来，<strong><a href="#v1.6.0%E9%9B%86%E7%BE%A4%E5%BB%BA%E7%AB%8B">1.6.0</a>改变了个行为</strong>，对于像存在类似缓存，或者数据中心的业务而言的单向节点而言，只需要一条连接即可，节省资源。</p>
</li>
<li>
<p><code>sktpmd</code>现在支持原始的<code>tcp,udp,unix</code>协议，后续规划可能由<code>reliable udp</code>实现，降低集群通讯延时并提供更好的性能和时延性。</p>
</li>
<li>
<p>远程命名服务，通过内置命令生成唯一的Name，通过Name来与其他节点通讯是友好的。</p>
</li>
</ol>
<h1 id="使用">使用</h1>
<ul>
<li>
<p>启动也非常简单，无须任何代码，仅仅只需要在 <code>conf.conf</code> 中配置一下即可，使用的时候跟节点内通讯无任何区别。因为我已经作平了本地和节点之间的差异。</p>
</li>
<li>
<p>内部均由<a href="/post/kproto">kproto</a>进行编码,提供更快的序列化方式。</p>
</li>
<li>
<p>example call</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-lua" data-lang="lua"><span class="line"><span class="cl"><span class="n">skynet</span><span class="o">-</span><span class="n">x.send</span><span class="p">(</span><span class="s2">&#34;host:port@name&#34;</span><span class="p">,</span><span class="s2">&#34;rpc&#34;</span><span class="p">...)</span> <span class="c1">-- 通过域名或者地址+端口的形式和其他节点进行通讯</span>
</span></span><span class="line"><span class="cl"><span class="n">skynet</span><span class="o">-</span><span class="n">x.send</span><span class="p">(</span><span class="s2">&#34;alias&#34;</span><span class="p">,</span><span class="s2">&#34;rpc&#34;</span><span class="p">,...)</span> <span class="c1">-- 通过别名</span>
</span></span><span class="line"><span class="cl"><span class="n">skynet</span><span class="o">-</span><span class="n">x.send</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="s2">&#34;rpc&#34;</span><span class="p">,...)</span>              <span class="c1">-- 通过pid亦可</span>
</span></span></code></pre></div><h1 id="tunnel"><del>tunnel</del></h1>
<p>既然节点之间是双向连接，所以连接数量为 <code>f(n) =  n²-n</code>，如果节点过的时候，势必造成 <code>socket fd</code> 消耗殆尽，</p>
<p>基于这个问题，可以通过内置的<code>tun</code>，来设置代理，这么一来，<code>tun</code>的作用相当于这个集群节点的网关。因为其内部的节点相对于其他 <code>tun</code> 代理是不可见的，</p>
<p>通过配置<code>tun</code>的规则开启多个，则可以实现业务拆分。</p>
<blockquote>
<p>2022-10-07 此模块被弃用，可以用多节点转接的方式或代理的方式做到，如 <code>send(&quot;n1.n2.n3@name&quot;)</code></p>
</blockquote>
<h1 id="服务发现"><del>服务发现</del></h1>
<p><code>sktpmd</code> 提供了一套服务发现机制，但其运作原理是不同于 <code>etcd</code> 或者 <code>consul</code>,它本身是一个惰性发现，它不需要一个中心服维持它们的关系。</p>
<blockquote>
<p>sktpmd整个发现流程是基于 <code>gossip</code> 算法来发现的,但一些api依然可以主动触发，<code>v1.6.0</code> 这个模块将保留，因为集群模式的逻辑改变了</p>
</blockquote>
<h1 id="v160集群建立">v1.6.0集群建立</h1>
<p><code>v1.5.0</code> 之前节点之间都是双向链接，但考虑到一个单向服务器，如 <code>dns server</code>,<code>conf server</code> 等，大部分是 <code>request/response</code> 模式，惰性连接的收益很大，所以去除之前的一些设计。</p>
<h1 id="网络底层">网络底层</h1>
<p>参考 <a href="/post/language/go/goroutine">Go协程的思考</a>,在<code>linux</code>下，使用了 <code>epoll</code>。所以尽量部署到 <code>linux</code> 下以发挥更好的性能</p>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              

              Created
              <relative-time datetime=" Mon, 30 May 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Mon, 30 May 2022 00:00:00 &#43;0000">
                Mon, 30 May 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/skynet/5/">zmalloc</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <p>无论是对于C版本还是Go版本的<code>skynet-x</code>而言，一个高效的内存分配器可以提高内存的使用效率，这里效率无论是对于内存碎片亦或是GC而言，都是一种更高效的手段</p>
<h1 id="基于-slab-算法的分段内存分配器">基于 <code>SLAB</code> 算法的分段内存分配器</h1>
<p><code>SLAB</code> 最开始是阅读 <code>linux</code> 源码学习的算法，在<code>skynet-x</code>中它确实有更优秀的性能，因为它直接分配了一块大共用内存，所以不会产生任何GC和真实分配,但在业务开发过程中，一旦忘记释放 那么这段内存将不能再被使用和获取了（也就是野指针），直到程序结束。最后的保守策略依然会向<code>runtime</code>申请内存，将会导致内存占用过高。</p>
<p>而且内置的<code>Debug</code>模式也无法定位到这个指针，原因在于 golang 堆栈伸缩会导致指针地址变动，所以 <code>Debug</code> 只能定位到存在 <code>memory-leak</code>，而无法知道具体位置。若需要具体位置则需要hook这个调用栈，性能方面得不偿失</p>
<h1 id="基于-syncpool-的分段内存分配器">基于 <code>sync.Pool</code> 的分段内存分配器</h1>
<p>将不同size的buffer放入不同的池中，按需进行分配，减少race的开销，这个方法虽然简单，但是性能是低于 <code>slab-allocator</code>。</p>
<p>但它确实能减轻心智负担，代价就是牺牲了部分性能以及gc压力，但这也是<code>skynet-x</code>默认使用的策略。如果需要使用可以在编译指令中指明<code>slab</code></p>
<h1 id="zmalloc">Zmalloc</h1>
<p><code>zmlloc</code> 本身也是 <code>slab</code>的升级版本，增加可伸缩链表实现对于预分配内存额外部分的缓冲池。</p>
<p>在24个线程的cpu条件测试结果如下,<code>zmalloc</code>保持了一种稳定的时间复杂度，额外产生的内存分配也很少</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">-</th>
          <th style="text-align: center">time(ns)</th>
          <th style="text-align: center">alloc/op(B)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">slab-128</td>
          <td style="text-align: center">23.5</td>
          <td style="text-align: center">1</td>
      </tr>
      <tr>
          <td style="text-align: left">sync.Pool-128</td>
          <td style="text-align: center">2490</td>
          <td style="text-align: center">65562</td>
      </tr>
      <tr>
          <td style="text-align: left">zmalloc-128</td>
          <td style="text-align: center">43.31</td>
          <td style="text-align: center">16</td>
      </tr>
      <tr>
          <td style="text-align: left">slab-256</td>
          <td style="text-align: center">24</td>
          <td style="text-align: center">256</td>
      </tr>
      <tr>
          <td style="text-align: left">sync.Pool-256</td>
          <td style="text-align: center">2204</td>
          <td style="text-align: center">65562</td>
      </tr>
      <tr>
          <td style="text-align: left">zmalloc-256</td>
          <td style="text-align: center">44</td>
          <td style="text-align: center">16</td>
      </tr>
      <tr>
          <td style="text-align: left">slab-1024</td>
          <td style="text-align: center">92</td>
          <td style="text-align: center">1024</td>
      </tr>
      <tr>
          <td style="text-align: left">sync.Pool-1024</td>
          <td style="text-align: center">2490</td>
          <td style="text-align: center">65562</td>
      </tr>
      <tr>
          <td style="text-align: left">zmalloc-1024</td>
          <td style="text-align: center">49</td>
          <td style="text-align: center">17</td>
      </tr>
      <tr>
          <td style="text-align: left">slab-4096</td>
          <td style="text-align: center">365</td>
          <td style="text-align: center">4096</td>
      </tr>
      <tr>
          <td style="text-align: left">sync.Pool-4096</td>
          <td style="text-align: center">2210</td>
          <td style="text-align: center">65562</td>
      </tr>
      <tr>
          <td style="text-align: left">zmalloc-4096</td>
          <td style="text-align: center">45</td>
          <td style="text-align: center">23</td>
      </tr>
  </tbody>
</table>
<h1 id="api">API</h1>
<ul>
<li>
<p><code>skynet.zalloc(n)</code> 用以分配指定大小的内存块，考虑到 64在go中为tiny-size，直接会从P上分配，所以zmalloc分配块从128开始</p>
</li>
<li>
<p><code>skynet.zrealloc(buf,n)</code> realloc函数会先检查buf，确保是否需要重新分配内存</p>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              

              Created
              <relative-time datetime=" Thu, 21 Apr 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Thu, 21 Apr 2022 00:00:00 &#43;0000">
                Thu, 21 Apr 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/lang/sync.pool/">sync.pool</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="结构分析">结构分析</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Pool</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">noCopy</span> <span class="nx">noCopy</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">local</span>     <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// P 本地池，固定尺寸，实际结构 [P]poolLocal，类似 void* 并附加长度构成了一个数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">localSize</span> <span class="kt">uintptr</span>        <span class="c1">// size of the local array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">victim</span>     <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span> <span class="c1">// local from previous cycle
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">victimSize</span> <span class="kt">uintptr</span>        <span class="c1">// size of victims array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">	<span class="nx">New</span> <span class="kd">func</span><span class="p">()</span> <span class="nx">any</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poolChain</span> <span class="kd">struct</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">head</span> <span class="o">*</span><span class="nx">poolChainElt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">tail</span> <span class="o">*</span><span class="nx">poolChainElt</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poolChainElt</span> <span class="kd">struct</span><span class="p">{</span> <span class="c1">// 一个双向链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">poolDequeue</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">next</span><span class="p">,</span><span class="nx">prev</span> <span class="o">*</span><span class="nx">poolChainElt</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poolDequeue</span> <span class="kd">struct</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">headtail</span> <span class="kt">uint64</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">vals</span> <span class="p">[]</span><span class="nx">eface</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">eface</span> <span class="kd">struct</span><span class="p">{</span>  <span class="c1">// 数据的真实内存分配，包括一个类型描述和实际数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">typ</span><span class="p">,</span><span class="nx">val</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nx">Pointer</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poolLocalInternal</span> <span class="kd">struct</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">private</span> <span class="nx">any</span> <span class="c1">// p的私有缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="nx">shared</span> <span class="nx">poolChain</span> <span class="c1">// 公共缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">poolLocal</span> <span class="kd">struct</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">poolLocalInternal</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">pad</span> <span class="p">[</span><span class="mi">128</span><span class="o">-</span><span class="nx">unsafe</span><span class="p">.</span><span class="nf">Sizeof</span><span class="p">(</span><span class="nx">poolLocalInternal</span><span class="p">{})</span><span class="o">%</span><span class="mi">128</span><span class="p">]</span><span class="kt">byte</span>  <span class="c1">// 应该是补位，可以确保刚好占满一个 cache line 加速访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h1 id="申请释放">申请释放</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">pin</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">poolLocal</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span> <span class="o">:=</span> <span class="nf">runtime_procPin</span><span class="p">()</span> <span class="c1">// 将当前G和P绑定，并返回P的id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">s</span> <span class="o">:=</span> <span class="nf">runtime_LoadAcquintptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">localSize</span><span class="p">)</span> <span class="c1">// load-acquire
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">l</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">local</span>                              <span class="c1">// load-consume
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">pid</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">s</span> <span class="p">{</span>  <span class="c1">// 主要是P的数量可能会变动 重新找一个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nf">indexLocal</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">pid</span><span class="p">),</span> <span class="nx">pid</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">p</span><span class="p">.</span><span class="nf">pinSlow</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">pinSlow</span><span class="p">()</span> <span class="p">(</span><span class="o">*</span><span class="nx">poolLocal</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">runtime_procUnpin</span><span class="p">()</span>  <span class="c1">// 禁止 P 抢占，否则当前G会被放回本地或者全局队列，当时之后G不一定在现在这个P上
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">allPoolsMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">defer</span> <span class="nx">allPoolsMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">pid</span> <span class="o">:=</span> <span class="nf">runtime_procPin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">localSize</span>
</span></span><span class="line"><span class="cl">	<span class="nx">l</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">local</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">pid</span><span class="p">)</span> <span class="p">&lt;</span> <span class="nx">s</span> <span class="p">{</span> <span class="c1">// double check
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">return</span> <span class="nf">indexLocal</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">pid</span><span class="p">),</span> <span class="nx">pid</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">local</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>  <span class="c1">// 如果本地队列为空，那么此时Pool没被初始化，加入全局池引用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">allPools</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">allPools</span><span class="p">,</span> <span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nx">size</span> <span class="o">:=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">GOMAXPROCS</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1">// 查看现在P的个数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">local</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">poolLocal</span><span class="p">,</span> <span class="nx">size</span><span class="p">)</span> <span class="c1">// 为这个Pool分配跟P数量相同的本地池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">atomic</span><span class="p">.</span><span class="nf">StorePointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">local</span><span class="p">,</span> <span class="nx">unsafe</span><span class="p">.</span><span class="nf">Pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">local</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="c1">// store-release
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">runtime_StoreReluintptr</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">p</span><span class="p">.</span><span class="nx">localSize</span><span class="p">,</span> <span class="nb">uintptr</span><span class="p">(</span><span class="nx">size</span><span class="p">))</span>     <span class="c1">// store-release
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">local</span><span class="p">[</span><span class="nx">pid</span><span class="p">],</span> <span class="nx">pid</span> <span class="c1">// 返回当前和P绑定的本地池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">Get</span><span class="p">()</span> <span class="nx">any</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">race</span><span class="p">.</span><span class="nf">Disable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">pid</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">pin</span><span class="p">()</span> <span class="c1">// 先找本地池
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">x</span> <span class="o">:=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">private</span>
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">.</span><span class="nx">private</span> <span class="p">=</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// 如果没有，那么从全局池找
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// Try to pop the head of the local shard. We prefer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// the head over the tail for temporal locality of
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// reuse.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">x</span><span class="p">,</span> <span class="nx">_</span> <span class="p">=</span> <span class="nx">l</span><span class="p">.</span><span class="nx">shared</span><span class="p">.</span><span class="nf">popHead</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">x</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">getSlow</span><span class="p">(</span><span class="nx">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">runtime_procUnpin</span><span class="p">()</span> <span class="c1">//释放P，让其可以被抢占
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">race</span><span class="p">.</span><span class="nf">Enable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nx">x</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">race</span><span class="p">.</span><span class="nf">Acquire</span><span class="p">(</span><span class="nf">poolRaceAddr</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">p</span><span class="p">.</span><span class="nx">New</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">x</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">New</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Put adds x to the pool.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">Pool</span><span class="p">)</span> <span class="nf">Put</span><span class="p">(</span><span class="nx">x</span> <span class="nx">any</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">x</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="nf">fastrandn</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="c1">// Randomly drop x on floor.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">return</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="nx">race</span><span class="p">.</span><span class="nf">ReleaseMerge</span><span class="p">(</span><span class="nf">poolRaceAddr</span><span class="p">(</span><span class="nx">x</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">		<span class="nx">race</span><span class="p">.</span><span class="nf">Disable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">l</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nf">pin</span><span class="p">()</span> <span class="c1">// 老规矩，先禁止P被抢占
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">l</span><span class="p">.</span><span class="nx">private</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span> <span class="c1">// 本地没有 则先放入本地
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nx">l</span><span class="p">.</span><span class="nx">private</span> <span class="p">=</span> <span class="nx">x</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">l</span><span class="p">.</span><span class="nx">shared</span><span class="p">.</span><span class="nf">pushHead</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="c1">// 否则放入全局
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">runtime_procUnpin</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">race</span><span class="p">.</span><span class="nx">Enabled</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nx">race</span><span class="p">.</span><span class="nf">Enable</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="gc">GC</h1>
<blockquote>
<p>其实很好理解，正好是一次二级缓冲模型，第一次gc会将local放入 victim，第二gc victim不为空才会真正清理，local不会参与gc</p>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              
              
              <a class="muted-link mr-3" href="/tags/sync.pool">
                <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                  <path fill-rule="evenodd"
                    d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                  </path>
                </svg>
                sync.pool
              </a>
              
              

              Created
              <relative-time datetime=" Fri, 15 Apr 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Fri, 15 Apr 2022 00:00:00 &#43;0000">
                Fri, 15 Apr 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
        <li class="col-12 d-flex width-full py-4 border-bottom color-border-secondary public source">
          <div class="col-12 d-inline-block">
            <div class="d-inline-block mb-1">
              <h3 class="wb-break-all">
                <a href="https://domyson.github.io/post/lang/cgo/">Cgo</a>
              </h3>
            </div>

            <div>
              <div class="col-12 d-inline-block text-gray mb-2 pr-4">
                <h1 id="cgo-一种go与c交互的技术">cgo 一种go与c交互的技术</h1>
<h2 id="开启cgo">开启cgo</h2>
<blockquote>
<p>要求系统安装C/C++工具链，macos和linux(gcc 自带)，windows(mingw),并确保环境变量<code>CGO_ENAVBLE=on</code>,最后单个源码需要导入 <code>import &quot;C&quot;</code></p>
</blockquote>
<h2 id="cgo类型映射">cgo类型映射</h2>
<table>
  <thead>
      <tr>
          <th>C type</th>
          <th>Cgo type</th>
          <th>Go type</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>char</td>
          <td>C.char</td>
          <td>byte</td>
      </tr>
      <tr>
          <td>signed char</td>
          <td>C.schar</td>
          <td>int8</td>
      </tr>
      <tr>
          <td>unsigned char</td>
          <td>C.uchar</td>
          <td>uint8</td>
      </tr>
      <tr>
          <td>short</td>
          <td>C.short</td>
          <td>int16</td>
      </tr>
      <tr>
          <td>unsigned short</td>
          <td>C.ushort</td>
          <td>uint16</td>
      </tr>
      <tr>
          <td>int</td>
          <td>C.int</td>
          <td>int32</td>
      </tr>
      <tr>
          <td>unsigned int</td>
          <td>C.uint</td>
          <td>uint32</td>
      </tr>
      <tr>
          <td>long</td>
          <td>C.long</td>
          <td>int32</td>
      </tr>
      <tr>
          <td>unsigned long</td>
          <td>C.ulong</td>
          <td>uint32</td>
      </tr>
      <tr>
          <td>long long int</td>
          <td>C.longlong</td>
          <td>int64</td>
      </tr>
      <tr>
          <td>unsigned long long int</td>
          <td>C.ulonglong</td>
          <td>uint64</td>
      </tr>
      <tr>
          <td>float</td>
          <td>C.float</td>
          <td>float32</td>
      </tr>
      <tr>
          <td>double</td>
          <td>C.double</td>
          <td>double</td>
      </tr>
      <tr>
          <td>size_t</td>
          <td>C.size_t</td>
          <td>uint</td>
      </tr>
  </tbody>
</table>
<h3 id="函数指针">函数指针</h3>
<blockquote>
<p>go引用c的函数指针比较特别</p>
</blockquote>
<ol>
<li>
<p>官方给出的<a href="https://github.com/golang/go/wiki/cgo#function-pointer-callbacks">Example</a></p>
</li>
<li>
<p>我这里给出另外一种,通过c wrap 这个函数指针成一个普通函数，然后go调用它</p>
              </div>
            </div>

            <div class="f6 text-gray mt-2">
              

              Created
              <relative-time datetime=" Wed, 06 Apr 2022 00:00:00 &#43;0000" class="no-wrap"
                title=" Wed, 06 Apr 2022 00:00:00 &#43;0000">
                Wed, 06 Apr 2022 00:00:00 &#43;0000
              </relative-time>
            </div>
          </div>
        </li>
        
      </ul>
      <div class="paginate-container">
        <div class="BtnGroup">
          
          <a rel="nofollow" class="btn btn-outline BtnGroup-item" href="/post/">Previous</a>
          
          
          <a rel="nofollow" class="btn btn-outline BtnGroup-item" href="/post/page/3/">Next</a>
          
        </div>
      </div>
    </div>
  </div>
</div>

      
    </div>
  </div>
</div>
<script>
window.onscroll = function (e) {
  const headerImg = document.querySelector('#headerImg');
  const headerStuck = document.querySelector('#headerStuck');
  if (headerImg.getBoundingClientRect().bottom <= 0) {
    headerStuck.classList.add('is-stuck');
    if (window.innerWidth >= 1280) {
      headerStuck.setAttribute('style', 'top: 12px;')
    } else {
      headerStuck.setAttribute('style', 'top: 0;')
    }
  } else {
    headerStuck.classList.remove('is-stuck');
  }
};

var style = localStorage.getItem('data-color-mode')
githubIconElement = document.getElementById('github-icon')
twitterIconElement = document.getElementById('twitter-icon')
if (style == 'light') {
  if (githubIconElement) githubIconElement.setAttribute('fill', '#24292e')
  if (twitterIconElement) twitterIconElement.setAttribute('fill', 'black')
}
else {
  if (githubIconElement) {
    githubIconElement.removeAttribute('fill')
    githubIconElement.setAttribute('class', 'octicon')
    githubIconElement.setAttribute('color', '#f0f6fc')
  }
  if (twitterIconElement)  twitterIconElement.setAttribute('fill', 'white') 
}
</script>

  

</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://domyson.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://domyson.github.io/js/github-style.js"></script>





<script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.min.js"></script>
<script type="application/javascript" src='https://domyson.github.io/js/search.js'></script>



</html>