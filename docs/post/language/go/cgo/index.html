<!doctype html>
<html lang="en">
  <head>
    <title>Cgo // Treasure</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.118.2">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Treasure" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="/css/main.min.3c3c186cd62e563ad6e2f00a89dbee656ab912d1d46f856b5605dd0232521e2a.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cgo"/>
<meta name="twitter:description" content="cgo 一种go与c交互的技术 开启cgo 要求系统安装C/C&#43;&#43;工具链，macos和linux(gcc 自带)，windows(mingw),并确保环境变量CGO_ENAVBLE=on,最后单个源码需要导入 import &quot;C&quot;
cgo类型映射 C type Cgo type Go type char C.char byte signed char C.schar int8 unsigned char C.uchar uint8 short C.short int16 unsigned short C.ushort uint16 int C.int int32 unsigned int C.uint uint32 long C.long int32 unsigned long C.ulong uint32 long long int C.longlong int64 unsigned long long int C.ulonglong uint64 float C.float float32 double C.double double size_t C.size_t uint 函数指针 go引用c的函数指针比较特别
官方给出的Example
我这里给出另外一种,通过c wrap 这个函数指针成一个普通函数，然后go调用它"/>

    <meta property="og:title" content="Cgo" />
<meta property="og:description" content="cgo 一种go与c交互的技术 开启cgo 要求系统安装C/C&#43;&#43;工具链，macos和linux(gcc 自带)，windows(mingw),并确保环境变量CGO_ENAVBLE=on,最后单个源码需要导入 import &quot;C&quot;
cgo类型映射 C type Cgo type Go type char C.char byte signed char C.schar int8 unsigned char C.uchar uint8 short C.short int16 unsigned short C.ushort uint16 int C.int int32 unsigned int C.uint uint32 long C.long int32 unsigned long C.ulong uint32 long long int C.longlong int64 unsigned long long int C.ulonglong uint64 float C.float float32 double C.double double size_t C.size_t uint 函数指针 go引用c的函数指针比较特别
官方给出的Example
我这里给出另外一种,通过c wrap 这个函数指针成一个普通函数，然后go调用它" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://domyson.github.io/post/language/go/cgo/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2022-04-06T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-04-06T00:00:00+00:00" />


  </head>
  <body>
    <header class="app-header">
      <a href="https://domyson.github.io"><img class="app-header-avatar" src="/avatar.jpg" alt="Treasure" /></a>
      <span class="app-header-title">Treasure</span>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
             - 
          
          <a class="app-header-menu-item" href="/about/">About</a>
      </nav>
      <p>无关迟暮,不问翻覆</p>
      <div class="app-header-social">
        
          <a href="https://github.com/domyson" target="_blank" rel="noreferrer noopener me">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Cgo</h1>
      <div class="post-meta">
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Apr 6, 2022
        </div>
        <div>
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          1 min read
        </div>
      </div>
    </header>
    <div class="post-content">
      <h1 id="cgo-一种go与c交互的技术">cgo 一种go与c交互的技术</h1>
<h2 id="开启cgo">开启cgo</h2>
<blockquote>
<p>要求系统安装C/C++工具链，macos和linux(gcc 自带)，windows(mingw),并确保环境变量<code>CGO_ENAVBLE=on</code>,最后单个源码需要导入 <code>import &quot;C&quot;</code></p>
</blockquote>
<h2 id="cgo类型映射">cgo类型映射</h2>
<table>
<thead>
<tr>
<th>C type</th>
<th>Cgo type</th>
<th>Go type</th>
</tr>
</thead>
<tbody>
<tr>
<td>char</td>
<td>C.char</td>
<td>byte</td>
</tr>
<tr>
<td>signed char</td>
<td>C.schar</td>
<td>int8</td>
</tr>
<tr>
<td>unsigned char</td>
<td>C.uchar</td>
<td>uint8</td>
</tr>
<tr>
<td>short</td>
<td>C.short</td>
<td>int16</td>
</tr>
<tr>
<td>unsigned short</td>
<td>C.ushort</td>
<td>uint16</td>
</tr>
<tr>
<td>int</td>
<td>C.int</td>
<td>int32</td>
</tr>
<tr>
<td>unsigned int</td>
<td>C.uint</td>
<td>uint32</td>
</tr>
<tr>
<td>long</td>
<td>C.long</td>
<td>int32</td>
</tr>
<tr>
<td>unsigned long</td>
<td>C.ulong</td>
<td>uint32</td>
</tr>
<tr>
<td>long long int</td>
<td>C.longlong</td>
<td>int64</td>
</tr>
<tr>
<td>unsigned long long int</td>
<td>C.ulonglong</td>
<td>uint64</td>
</tr>
<tr>
<td>float</td>
<td>C.float</td>
<td>float32</td>
</tr>
<tr>
<td>double</td>
<td>C.double</td>
<td>double</td>
</tr>
<tr>
<td>size_t</td>
<td>C.size_t</td>
<td>uint</td>
</tr>
</tbody>
</table>
<h3 id="函数指针">函数指针</h3>
<blockquote>
<p>go引用c的函数指针比较特别</p>
</blockquote>
<ol>
<li>
<p>官方给出的<a href="https://github.com/golang/go/wiki/cgo#function-pointer-callbacks">Example</a></p>
</li>
<li>
<p>我这里给出另外一种,通过c wrap 这个函数指针成一个普通函数，然后go调用它</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">//example.h
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">int</span> (<span style="color:#f92672">*</span>add)(<span style="color:#66d9ef">int</span> a);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">wrap_add</span>(add f,<span style="color:#66d9ef">int</span> a){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(f){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">add</span>(a);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="structunionenum">struct、union、enum</h2>
<ol>
<li>
<p>go通过<code>C.struct_XXX</code> 来访问c中的结构体，若结构体是 typedef 定义的则不需要 <code>struct_</code> 前缀</p>
</li>
<li>
<p>若c中结构体名称是go关键字，则需要加 <code>_</code>，如 _type</p>
</li>
<li>
<p>union在go中会被替换成等长byte数组</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//example.go
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">union U1{
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    int a;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    long long int b;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">};
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;C&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Mock</span>(){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u</span> = <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">union_U1</span>; <span style="color:#75715e">// u的type为 [8]byte
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div></li>
<li>
<p>枚举在cgo中会被替换为一个常量，通过 C.Enum来访问</p>
</li>
</ol>
<h2 id="函数调用">函数调用</h2>
<blockquote>
<p>c call go: 通过编译指示 <code>go:export</code>来导出可供c调用的函数，但是参数及返回值都是c类型</p>
</blockquote>
<blockquote>
<p>go call c: 通过<code>C.funcName</code>来调用，但是参数及返回值都是c类型</p>
</blockquote>
<h3 id="关于-errnoh">关于 <code>&lt;errno.h&gt;</code></h3>
<blockquote>
<p>因为C语言不支持返回多个结果，因此&lt;errno.h&gt;标准库提供了一个errno宏用于返回错误状态。我们可以近似地将errno看着一个线程安全的全局变量，可以用于记录最近一次错误的状态码，
CGO也针对&lt;errno.h&gt;标准库的errno宏做的特殊支持：在CGO调用C函数时如果有两个返回值，那么第二个返回值将对应errno错误状态。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;errno.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">div</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b){  <span style="color:#75715e">// 如果b=0,在go中将返回 (0,invalid argument)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span>(b <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>        erron <span style="color:#f92672">=</span> EINVAL;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> a<span style="color:#f92672">/</span>b;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="编译和连接参数-linkhttpswwwcntofucombook73ch2-cgoch2-11-linkmd">编译和连接参数 <a href="https://www.cntofu.com/book/73/ch2-cgo/ch2-11-link.md">Link</a></h2>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
