<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://domyson.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://domyson.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/light.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://domyson.github.io/css/syntax.css' />
    <title>Nginx - 朝花夕拾</title>
    
    <link rel="icon" type="image/x-icon" href='/images/avatar.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    <meta name="description"
  content="简介 Nginx功能丰富，可作为HTTP服务器，也可作为反向代理服务器，邮件服务器。支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能。并且支持很多第三方的模块扩展。
Nginx下载
常用功能 负载均衡
反向代理
正向代理
文件服务器
" />
<meta name="keywords"
  content='computer tech' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://domyson.github.io/post/nginx/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Nginx - 朝花夕拾" />
<meta name="twitter:description"
  content="简介 Nginx功能丰富，可作为HTTP服务器，也可作为反向代理服务器，邮件服务器。支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能。并且支持很多第三方的模块扩展。
Nginx下载
常用功能 负载均衡
反向代理
正向代理
文件服务器
" />
<meta name="twitter:site" content="https://domyson.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://domyson.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="Nginx - 朝花夕拾">
<meta property="og:description"
  content="简介 Nginx功能丰富，可作为HTTP服务器，也可作为反向代理服务器，邮件服务器。支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能。并且支持很多第三方的模块扩展。
Nginx下载
常用功能 负载均衡
反向代理
正向代理
文件服务器
" />
<meta property="og:url" content="https://domyson.github.io/post/nginx/" />
<meta property="og:site_name" content="Nginx" />
<meta property="og:image"
  content="https://domyson.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2019-03-09 00:00:00 &#43;0000 UTC" />











</head>

<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://domyson.github.io/">
        <img class="octicon" height="32" width="32" src="">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <img height="24" class="octicon octicon-three-bars" width="24" src="">
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          <form target="_blank" action="https://www.google.com/search" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="q" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="q" value="site:https://domyson.github.io/">
            </label>
          </form>
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://domyson.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>

  
<div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://domyson.github.io/">
                  <img class=" avatar-user"
                    src="https://domyson.github.io/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://domyson.github.io/">Treasure</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://domyson.github.io/post/nginx/">Nginx</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sat, 09 Mar 2019 00:00:00 &#43;0000"
                    class="no-wrap">
                    Sat, 09 Mar 2019 00:00:00 &#43;0000</relative-time>

                  
                  <span class="file-info-divider"></span>
                  Modified <relative-time datetime="Mon, 20 May 2024 09:31:59 &#43;0800"
                    class="no-wrap">
                    Mon, 20 May 2024 09:31:59 &#43;0800</relative-time>
                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      2005 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h1 id="简介">简介</h1>
<blockquote>
<p>Nginx功能丰富，可作为HTTP服务器，也可作为反向代理服务器，邮件服务器。支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能。并且支持很多第三方的模块扩展。</p>
</blockquote>
<p><a href="http://nginx.org/en/download.html">Nginx下载</a></p>
<h1 id="常用功能">常用功能</h1>
<ul>
<li>
<p>负载均衡</p>
</li>
<li>
<p>反向代理</p>
</li>
<li>
<p>正向代理</p>
</li>
<li>
<p>文件服务器</p>
</li>
</ul>
<h1 id="nginx命令">Nginx命令</h1>
<ul>
<li>
<p><code>nginx -s [reload|start|stop|quit]</code> 向nginx发送一个信号</p>
</li>
<li>
<p><code>nginx -c path</code> 指定nginx启动配置，<code>linux</code> 默认在 <code>/etc/nginx/nginx.conf</code> 下</p>
</li>
<li>
<p><code>nginx -g &quot;daemon off;&quot;</code>  不以守护进程的方式启动，这点在 <code>docker</code> 中特别重要，默认是以守护进程的方式启动</p>
</li>
</ul>
<h1 id="nginx正向代理">Nginx正向代理</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 配置DNS解析IP地址，比如 Google Public DNS，以及超时时间（5秒）
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">resolver</span> <span class="mi">8</span><span class="s">.8.8.8</span><span class="p">;</span>    <span class="c1"># 必需
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">resolver_timeout</span> <span class="s">5s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 监听端口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kn">listen</span> <span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">access_log</span>  <span class="s">/home/reistlin/logs/proxy.access.log</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kn">error_log</span>   <span class="s">/home/reistlin/logs/proxy.error.log</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 配置正向代理参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_pass</span> <span class="nv">$scheme://$host$request_uri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 解决如果URL中带&#34;.&#34;后Nginx 503错误
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 配置缓存大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_buffers</span> <span class="mi">256</span> <span class="mi">4k</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 关闭磁盘缓存读写减少I/O
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_max_temp_file_size</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">         <span class="c1"># 代理连接超时时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_connect_timeout</span> <span class="mi">30</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># 配置代理服务器HTTP状态缓存时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">proxy_cache_valid</span> <span class="mi">200</span> <span class="mi">302</span> <span class="mi">10m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_cache_valid</span> <span class="mi">301</span> <span class="s">1h</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_cache_valid</span> <span class="s">any</span> <span class="mi">1m</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><blockquote>
<p>添加环境变量  <strong>http_proxy=http://192.168.1.9:8080</strong>  unix系统需要重新  <code>source /etc/profile</code> 来应用环境变量</p>
</blockquote>
<h1 id="nginx文件服务器">Nginx文件服务器</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#增加一个 server 模块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">server{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="s">listen</span>       <span class="mi">8080</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">server_name</span>  <span class="mi">8</span><span class="s">.8.8.8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">charset</span> <span class="s">utf-8</span><span class="p">;</span> <span class="c1">#设置编码，防止乱码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#root         /usr/share/nginx/html;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">root</span>         <span class="s">/data/</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">autoindex</span> <span class="no">on</span><span class="p">;</span>               <span class="c1">#显示目录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="kn">autoindex_exact_size</span> <span class="no">on</span><span class="p">;</span>    <span class="c1">#显示文件大小
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="kn">autoindex_localtime</span> <span class="no">on</span><span class="p">;</span>     <span class="c1">#显示文件时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="kn">auth_basic</span> <span class="s">&#34;treasure&#34;</span><span class="p">;</span>     <span class="c1">#密码提示短语
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="kn">auth_basic_user_file</span> <span class="s">/blog/nginx/htpasswd</span><span class="p">;</span> <span class="c1">#认证密码访问路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">error_page</span> <span class="mi">404</span> <span class="s">/40x.html</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">location</span> <span class="p">=</span> <span class="s">/40x.html</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">}</span>
</span></span></code></pre></div><h1 id="nginxconf">nginx.conf</h1>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="c1">#user  nobody;                          #运行用户，可不设置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">worker_processes</span>  <span class="mi">1</span><span class="p">;</span>                    <span class="c1">#工作进程，一般为cpu荷属
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#error_log  logs/error.log;             #日志文件路径，后面是日志等级
</span></span></span><span class="line"><span class="cl"><span class="c1">#error_log  logs/error.log  notice;
</span></span></span><span class="line"><span class="cl"><span class="c1">#error_log  logs/error.log  info;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">#pid        logs/nginx.pid;             #进程pid文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">events</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">use</span> <span class="s">epoll</span><span class="p">;</span>                          <span class="c1">#epoll是多路I/O复用，可极大提高性能，select,poll,kqueue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">accept_mutex</span> <span class="no">on</span><span class="p">;</span>                    <span class="c1"># 连接互斥，防止惊群现象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">multi-accept</span> <span class="no">on</span><span class="p">;</span>                    <span class="c1"># 进程接收多个连接
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">worker_connections</span>  <span class="mi">1024</span><span class="p">;</span>           <span class="c1">#单个worker最大的并发数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">http</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">include</span>       <span class="s">mime.types</span><span class="p">;</span>           <span class="c1">#文件拓展名映射表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">default_type</span>  <span class="s">application/octet-stream</span><span class="p">;</span> <span class="c1">#默认文件类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">log_format</span>  <span class="s">format</span>  <span class="s">&#39;</span><span class="nv">$remote_addr</span> <span class="s">-</span> <span class="nv">$remote_user</span> <span class="s">[</span><span class="nv">$time_local]</span> <span class="s">&#34;</span><span class="nv">$request&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                     <span class="s">&#39;</span><span class="nv">$status</span> <span class="nv">$body_bytes_sent</span> <span class="s">&#34;</span><span class="nv">$http_referer&#34;</span> <span class="s">&#39;</span>
</span></span><span class="line"><span class="cl">                      <span class="s">&#39;&#34;</span><span class="nv">$http_user_agent&#34;</span> <span class="s">&#34;</span><span class="nv">$http_x_forwarded_for&#34;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                        <span class="c1">#日志格式
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#access_log  logs/access.log  format;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile</span>        <span class="no">on</span><span class="p">;</span>                     <span class="c1"># 允许sendfile方式传输文件，默认为off，可以在http块，server块，location块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           
</span></span><span class="line"><span class="cl">    <span class="kn">sendfile_max_chunk</span> <span class="mi">100k</span><span class="p">;</span>                <span class="c1">#每个进程每次调用传输数量不能大于设定的值，默认为0，即不设上限
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#tcp_nopush     on;                     # 默认关闭，关闭 nagle 算法，同 sendfile 一起使用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#tcp_nodelay    on;                     # 与 tcp_nopush互斥
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">keepalive_timeout</span>  <span class="mi">65</span><span class="p">;</span>                  <span class="c1"># 连接超时时间，单位s
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#----------------- gzip --------------------#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip  on;                                  #开启 gzip压缩功能
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip_min_length 1k;                        #允许最小压缩字节数，建议大于1k
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip_buffers 4 32k;                        #分配4块大小为32k的缓冲块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip_http_version 1.0;                     #gzip版本
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip_comp_level 8;                         #压缩等级 0~9
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip_types         text/plain application/x-javascropt text/css application/xml #使用gzip压缩的类型
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#gzip_vary on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">error_page</span> <span class="mi">404</span> <span class="s">http://xxxxx.yyy</span><span class="p">;</span>             <span class="c1"># http全局错误页
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="kn">upstream</span> <span class="s">serverName</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">server</span> <span class="n">8.8.8.8</span><span class="p">:</span><span class="mi">80</span> <span class="s">weight=1</span> <span class="s">max_fails=2</span> <span class="s">fail_timeout=30s</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">server</span> <span class="n">0.0.0.0</span><span class="p">:</span><span class="mi">81</span> <span class="s">backup</span><span class="p">;</span> <span class="c1">#热备
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#若只有一个负载服务器，则不能设置权重，最大失败数为2，超过则认为主机不可用，
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#30s表示两次连接失败的超时时间间隔
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1"># ll+weight：轮询加权算法，默认
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">        <span class="c1"># ip_hash: 哈希算法，可能使部分服务器负载变大
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1"># least_conn: 最少链接，优先分配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1"># least_time: 相应最快的权重越大
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                                                      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">listen</span>       <span class="mi">80</span><span class="p">;</span>                                <span class="c1">#监听端口
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">server_name</span>  <span class="s">localhost</span><span class="p">;</span>                         <span class="c1">#监听地址或域名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#root                                           #此server块全局资源路径
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#index index.html  index.htm                    #此server块全局索引界面,首页排序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#charset koi8-r;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#access_log  logs/host.access.log  main;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#error_page 404 405 /40x.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#error_page 500 502 503 504 /50x.html           #server全局错误页面定向到location
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">root</span>   <span class="s">html</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">index</span>  <span class="s">index.html</span> <span class="s">index.htm</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="kn">error_page</span> <span class="mi">404</span> <span class="mi">405</span> <span class="s">/50x.html</span> <span class="c1">#错误页面定向到其他 location
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="err">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="s">location</span> <span class="s">/proxy/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">           <span class="kn">proxy_pass</span> <span class="s">http://1.1.1.1:80/proxy/</span><span class="p">;</span>        <span class="c1">#代理网址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>                <span class="c1">#代理网站域名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>    <span class="c1">#远程地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>           <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add-x_forwarder_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#error_page  404              /404.html;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1"># redirect server error pages to the static page /50x.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kn">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span>  <span class="s">/50x.html</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">location</span> <span class="p">=</span> <span class="s">/50x.html</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kn">root</span>   <span class="s">html</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># proxy the PHP scripts to Apache listening on 127.0.0.1:80
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#location ~ \.php$ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#    proxy_pass   http://127.0.0.1;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1"># pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#location ~ \.php$ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#    root           html;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#    fastcgi_pass   127.0.0.1:9000;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#    fastcgi_index  index.php;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#    include        fastcgi_params;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1"># deny access to .htaccess files, if Apache&#39;s document root
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1"># concurs with nginx&#39;s one
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#location ~ /\.ht {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#    deny  all;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#location ~.*\.(js|css)?$ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">#expires 30d;                   #客户端缓存js,css 30天
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">#access_log off;                #关闭日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">#location /resources/ {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">#deny all;              #禁止所有ip访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">#allow 4.4.4.4;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">#aloow 5.5.5.5;         #允许访问的ip
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">#}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># another virtual host using mix of IP-, name-, and port-based configuration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#server {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    listen       8000;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    listen       somename:8080;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    server_name  somename  alias  another.alias;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    location / {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#        root   html;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#        index  index.html index.htm;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># HTTPS server
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#server {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    listen       443 ssl;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    server_name  localhost;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    ssl_certificate      cert.pem;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    ssl_certificate_key  cert.key;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    ssl_session_cache    shared:SSL:1m;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    ssl_session_timeout  5m;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    ssl_ciphers  HIGH:!aNULL:!MD5;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    ssl_prefer_server_ciphers  on;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#    location / {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#        root   html;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#        index  index.html index.htm;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#    }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h1 id="路径匹配规则">路径匹配规则</h1>
<blockquote>
<p>访问  <code>http://treasure.com/abc/index.html</code></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">location</span> <span class="s">/abc/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_pass</span> <span class="s">http://treasure.com/</span><span class="p">;</span> <span class="c1"># 有 / 后缀会被location 截断
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#将代理成 http://treasure.com/index.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">location</span> <span class="s">/abc/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">proxy_pass</span> <span class="s">http://treasure.com</span><span class="p">;</span> <span class="c1"># 无 / 后最会被完整转发
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">#将代理成 http://treasure.com/abc/index.html
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#通用匹配 任何请求都会被捕获
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">location</span> <span class="s">^~</span> <span class="s">/res/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 匹配任何以 /res/ 开头的URL，并停止向下搜索，任何正则表达式不会被测试
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></div><h1 id="防盗链">防盗链</h1>
<blockquote>
<p>http标准协议中有专门的字段记录 <code>referer</code>，他可以追溯到请求时从哪个网站链接过来的，来对于资源文件，可以跟踪到包含显示他的网页地址是什么。因此所有防盗链方法都是基于这个Referer字段，nginx防盗链是通过分析访问资源的源网站，即referer来自哪里</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="k">location</span> <span class="p">~</span><span class="sr">*</span> <span class="s">\.(gif|jpg|png|bmp)</span>$ <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">valid_referers</span> <span class="s">none</span> <span class="s">blocked</span> <span class="s">a.b.c</span> <span class="s">a1.b1.c1</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#如果浏览器直接打开img的url，这时候是没有referer的，如果容许这一类，那么配置valid_referers可以包括none
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">#如果referer不为空，但是里面的内容被防火墙或者代理服务器删除了，也容许这一类的话，可以通过配置blocked来绕过。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 容许来自指定网站的请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="s">if</span> <span class="s">(</span><span class="nv">$invalid_referer</span><span class="s">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">return</span> <span class="mi">403</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">#rewrite ^/ http://www.any.com/403.jpg;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h1 id="高速缓存">高速缓存</h1>
<blockquote>
<p>Nginx可以缓存一些文件（一般是静态文件），减少Nginx与后端服务器的IO，提高用户访问速度。而且当后端服务器宕机时，Nginx服务器能给出相应的缓存文件响应相关的用户请求。</p>
</blockquote>
<h1 id="第三方模块编译">第三方模块编译</h1>
<p>待完善</p>
<h1 id="源码分析">源码分析</h1>
<p>懒得写 之后再写</p></article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://domyson.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://domyson.github.io/css/toc.css' />


<div id="gitalk-container" class="gitalk-container"></div>
<link rel="stylesheet" href='https://domyson.github.io/css/gitalk.css'>
<script src='https://domyson.github.io/js/gitalk.min.js'></script>
<script>
  const gitalk = new Gitalk({
    clientID: '258cd417c7c5b85f68e3',
    clientSecret: '4fd96cf3d02ea5bf11e9c29b159e2041557493e6',
    repo: 'domyson.github.io',
    owner: 'domyson',
    admin: ['domyson'],
    id: eval("location.pathname"), 
    distractionFreeMode: false 
  });
  (function() {
    gitalk.render('gitalk-container');
  })();
</script>


  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://domyson.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>
</body>

<script type="application/javascript" src="https://domyson.github.io/js/github-style.js"></script>




</html>